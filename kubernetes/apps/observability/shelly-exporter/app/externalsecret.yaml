---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: shelly-exporter
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: shelly-exporter-secret
    template:
      engineVersion: v2
      data:
        config.yaml: |
          listenAddress: :8080
          debug: false
          deviceUpdateInterval: 30
          devices:
          {{- range $name, $value := .}}
          {{- $parts := splitList "," $value}}
          - host: {{ index $parts 0 }}
          {{- if gt (len $parts) 1}}
            password: {{ index $parts 1 }}
          {{- end}}
          {{- end}}
  dataFrom:
    - extract:
        key: Shelly Exporter
