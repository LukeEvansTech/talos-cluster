---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: fluent-bit
  values:
    crds:
      enabled: true
    config:
      service: |
        [SERVICE]
            Daemon off
            Flush 30
            Log_Level warn
            Parsers_File /fluent-bit/etc/parsers.conf
            Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
            HTTP_Server on
            HTTP_Listen 0.0.0.0
            HTTP_Port 2020
            Health_Check on
      inputs: |
        [INPUT]
            Name tail
            Path /var/log/containers/*.log
            Tag kube.*
            Parser containerd
            multiline.parser containerd
            Refresh_Interval 10
            Mem_Buf_Limit 50MB
            Skip_Long_Lines on
      filters: |
        [FILTER]
            Name kubernetes
            Match kube.*
            Kube_URL https://kubernetes.default.svc:443
            Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
            Kube_Tag_Prefix kube.var.log.containers.
            Merge_Log on
            Keep_Log off
            K8S-Logging.Parser on
            K8S-Logging.Exclude on
            Labels on
            Annotations off
        [FILTER]
            Name nest
            Match kube.*
            Operation lift
            Nested_under kubernetes
            Add_prefix kubernetes_
        [FILTER]
            Name modify
            Match kube.*
            Rename kubernetes_labels_app.kubernetes.io/name app
        [FILTER]
            Name modify
            Match kube.*
            Condition Key_Does_Not_Exist app
            Rename kubernetes_labels_app.kubernetes.io/instance app
        [FILTER]
            Name modify
            Match kube.*
            Condition Key_Does_Not_Exist app
            Rename kubernetes_labels_app app
      outputs: |
        [OUTPUT]
            Name http
            Match kube.*
            Host victoria-logs.observability.svc.cluster.local
            Port 9428
            URI /insert/jsonline?_stream_fields=stream,namespace_name,pod_name,app&_msg_field=log&_time_field=date
            Format json_lines
            Json_date_key date
            Json_date_format iso8601
            Header AccountID 0
            Header ProjectID 0
            compress gzip
      customParsers: |
        [PARSER]
            Name containerd
            Format regex
            Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
            Time_Key time
            Time_Format %Y-%m-%dT%H:%M:%S.%L%z
    dashboards:
      enabled: true
    serviceMonitor:
      enabled: true
