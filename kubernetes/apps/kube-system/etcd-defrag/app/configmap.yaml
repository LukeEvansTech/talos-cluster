---
apiVersion: v1
kind: ConfigMap
metadata:
  name: etcd-defrag-script
data:
  defrag.sh: |-
    #!/bin/sh
    set -eu

    # etcd Defragmentation Script for Talos Linux
    # This script defrags all etcd members sequentially to avoid quorum loss

    echo "=========================================="
    echo "etcd Defragmentation Script"
    echo "=========================================="
    echo "Start time: $(date)"
    echo ""

    # Control plane nodes (hardcoded for sh compatibility)
    NODE1="10.32.8.80"
    NODE2="10.32.8.81"
    NODE3="10.32.8.82"
    NODE1_NAME="cr-talos-01"
    NODE2_NAME="cr-talos-02"
    NODE3_NAME="cr-talos-03"

    # Check if talosctl is available
    if ! command -v talosctl > /dev/null 2>&1; then
        echo "ERROR: talosctl not found in PATH"
        exit 1
    fi

    # Build minimal talosconfig from certificate components
    echo "Building talosconfig from certificate components..."
    SECRETS_DIR="/var/run/secrets/talos"

    if [ ! -f "$SECRETS_DIR/ca" ] || [ ! -f "$SECRETS_DIR/crt" ] || [ ! -f "$SECRETS_DIR/key" ]; then
        echo "ERROR: Required certificate files not found in $SECRETS_DIR"
        exit 1
    fi

    # Create minimal talosconfig with only etcd-defrag permissions needed
    export TALOSCONFIG="/tmp/talosconfig"

    # Read certificate components
    CA_DATA=$(cat "$SECRETS_DIR/ca")
    CRT_DATA=$(cat "$SECRETS_DIR/crt")
    KEY_DATA=$(cat "$SECRETS_DIR/key")

    # Build talosconfig using printf (avoiding heredoc to work with YAML)
    printf '%s\n' \
      "context: kubernetes" \
      "contexts:" \
      "  kubernetes:" \
      "    endpoints:" \
      "      - $${NODE1}" \
      "      - $${NODE2}" \
      "      - $${NODE3}" \
      "    ca: $${CA_DATA}" \
      "    crt: $${CRT_DATA}" \
      "    key: $${KEY_DATA}" \
      > "$TALOSCONFIG"

    echo "✓ Talosconfig created"
    echo ""

    echo "Checking etcd cluster health before defragmentation..."
    echo "Checking $NODE1_NAME ($NODE1)..."
    if ! talosctl -n "$NODE1" service etcd status > /dev/null 2>&1; then
        echo "WARNING: Cannot reach etcd on $NODE1_NAME ($NODE1)"
    fi
    echo "Checking $NODE2_NAME ($NODE2)..."
    if ! talosctl -n "$NODE2" service etcd status > /dev/null 2>&1; then
        echo "WARNING: Cannot reach etcd on $NODE2_NAME ($NODE2)"
    fi
    echo "Checking $NODE3_NAME ($NODE3)..."
    if ! talosctl -n "$NODE3" service etcd status > /dev/null 2>&1; then
        echo "WARNING: Cannot reach etcd on $NODE3_NAME ($NODE3)"
    fi
    echo ""

    # Helper function to defrag a single node
    defrag_node() {
        NODE="$1"
        NODE_NAME="$2"

        echo "=========================================="
        echo "Defragmenting $NODE_NAME ($NODE)..."
        echo "=========================================="

        # Get pre-defrag status
        echo "Before defragmentation:"
        talosctl -n "$NODE" service etcd status || true
        echo ""

        # Perform defragmentation
        echo "Running defragmentation (this may take 30-60 seconds)..."
        if talosctl -n "$NODE" service etcd defragment; then
            echo "✓ Defragmentation completed successfully"
        else
            echo "✗ Defragmentation failed on $NODE_NAME"
            exit 1
        fi
        echo ""

        # Get post-defrag status
        echo "After defragmentation:"
        talosctl -n "$NODE" service etcd status || true
        echo ""
    }

    # Defragment each node sequentially
    defrag_node "$NODE1" "$NODE1_NAME"
    echo "Waiting 10 seconds before next node..."
    sleep 10
    echo ""

    defrag_node "$NODE2" "$NODE2_NAME"
    echo "Waiting 10 seconds before next node..."
    sleep 10
    echo ""

    defrag_node "$NODE3" "$NODE3_NAME"

    echo "=========================================="
    echo "Defragmentation Complete!"
    echo "=========================================="
    echo "End time: $(date)"
    echo ""
    echo "Final cluster status:"
    talosctl -n "$NODE1,$NODE2,$NODE3" service etcd status || true
