---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: wapy
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: wapy-secret
    template:
      engineVersion: v2
      data:
        # Database connection
        DATABASE_URL: "postgres://{{ .WAPY_POSTGRES_USER }}:{{ .WAPY_POSTGRES_PASS }}@postgres18-rw.database.svc.cluster.local:5432/{{ .POSTGRES_DB }}?sslmode=disable"
        # Init container vars
        INIT_POSTGRES_DBNAME: "{{ .POSTGRES_DB }}"
        INIT_POSTGRES_HOST: postgres18-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .WAPY_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .WAPY_POSTGRES_PASS }}"
        INIT_POSTGRES_SUPER_USER: "{{ .POSTGRES_SUPER_USER }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        # Email configuration
        EMAIL_SERVER_USER: "{{ .EMAIL_SERVER_USER }}"
        EMAIL_SERVER_PASSWORD: "{{ .EMAIL_SERVER_PASSWORD }}"
        EMAIL_SERVER_HOST: "{{ .EMAIL_SERVER_HOST }}"
        EMAIL_SERVER_PORT: "{{ .EMAIL_SERVER_PORT }}"
        EMAIL_FROM: "{{ .EMAIL_FROM }}"
        EMAIL_CONTACT_EMAIL: "{{ .EMAIL_CONTACT_EMAIL }}"
        # Authentication
        AUTH_SECRET: "{{ .AUTH_SECRET }}"
        SUBSCRIPTION_JWT_SECRET: "{{ .SUBSCRIPTION_JWT_SECRET }}"
        # Site configuration
        SITE_URL: "{{ .SITE_URL }}"
        DISABLE_USER_REGISTRATION: "{{ .DISABLE_USER_REGISTRATION }}"
  dataFrom:
    - extract:
        key: wapy
    - extract:
        key: cloudnative-pg
