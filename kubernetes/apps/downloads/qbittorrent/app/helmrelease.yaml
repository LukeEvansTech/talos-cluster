---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: qbittorrent
spec:
  interval: 1h
  timeout: 10m
  chartRef:
    kind: OCIRepository
    name: qbittorrent
  values:
    controllers:
      qbittorrent:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            nameOverride: qbittorrent
            image:
              repository: ghcr.io/home-operations/qbittorrent
              tag: 5.1.4@sha256:56ecd30a7f5e1357daf5eea2a6935134d329b7b268a3a9b9c67041b65fb87fc6
            env:
              QBT_WEBUI_PORT: &port 80
              QBT_TORRENTING_PORT: &BT-port 51749
              QBT_Preferences__WebUI__LocalHostAuth: false
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *port
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 5
              readiness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *port
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 5
              startup:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *port
                  periodSeconds: 5
                  failureThreshold: 30
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                memory: 256Mi
          gluetun-webui:
            dependsOn: app
            image:
              repository: docker.io/scuzza/gluetun-webui
              tag: latest
            env:
              GLUETUN_CONTROL_URL: http://localhost:8000
              PORT: &gluetun-webui-port 3000
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *gluetun-webui-port
                  periodSeconds: 60
                  timeoutSeconds: 5
                  failureThreshold: 5
              readiness:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *gluetun-webui-port
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 5
              startup:
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *gluetun-webui-port
                  periodSeconds: 5
                  failureThreshold: 30
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 10m
                memory: 50Mi
              limits:
                memory: 128Mi
        initContainers:
          gluetun:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.41.1@sha256:1a5bf4b4820a879cdf8d93d7ef0d2d963af56670c9ebff8981860b6804ebc8ab
            env:
              # BLOCK_MALICIOUS: off # save 300MB of RAM; https://github.com/qdm12/gluetun/issues/2054
              DOT: "on"
              DOT_CACHING: "on"
              DOT_IPV6: off
              # is absolutely needed if the container is expected to be able to resolve or communicate to any cluster services, without it cluster services cannot be resolved consistently or at all in many setups.
              DNS_KEEP_NAMESERVER: "on"
              FIREWALL: true
              FIREWALL_DEBUG: on
              FIREWALL_INPUT_PORTS: 80,3000,9999
              FIREWALL_OUTBOUND_SUBNETS: '"${CLUSTER_PODS_CIDR},${CLUSTER_SVCS_CIDR},${CR_LAN_CIDR},${GH_LAN_CIDR}"'
              HEALTH_SERVER_ADDRESS: ":9999"
              HEALTH_SERVER_DISABLE_LOOP: on
              HEALTH_VPN_DURATION_INITIAL: 60s
              LOG_LEVEL: debug
              #TODO - Enable when ready - https://github.com/qdm12/gluetun-wiki/blob/main/setup/options/others.md. Getting ""ERROR public ip check settings: API name: API name is not valid: "cloudflare" can only be "ipinfo" or "ip2location""
              # PUBLICIP_API: cloudflare
              # STORAGE_FILEPATH: "" # prevent memory spike and avoid I/O
              TZ: ${TIMEZONE}
              UPDATER_PERIOD: 12h
              VERSION_INFORMATION: off
              VPN_INTERFACE: wg0
              VPN_IPV6_SERVER: off
              VPN_TYPE: wireguard
            envFrom:
              - secretRef:
                  name: qbittorrent-secret
            probes:
              liveness:
                enabled: false
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 9999
                  timeoutSeconds: 10
                  periodSeconds: 30
                  failureThreshold: 5
              startup:
                enabled: false
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 9999
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  failureThreshold: 5
            restartPolicy: Always
            securityContext:
              runAsUser: 0
              runAsNonRoot: false
              capabilities:
                add:
                  - NET_ADMIN
              allowPrivilegeEscalation: false
            resources:
              limits:
                kernel.org/tun: 1
        pod:
          labels:
            gluetun: "true"

          # dnsdist:
          #   image:
          #     repository: docker.io/powerdns/dnsdist-19
          #     tag: 1.9.7
          #   restartPolicy: Always
    defaultPodOptions:
      terminationGracePeriodSeconds: 300
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        controller: qbittorrent
        # nameOverride: qbittorrent
        ports:
          http:
            port: *port
      gluetun:
        controller: qbittorrent
        # nameOverride: gluetun
        ports:
          http:
            port: 8888
      gluetun-webui:
        controller: qbittorrent
        ports:
          http:
            port: *gluetun-webui-port
    route:
      app:
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN}"
          - "{{ .Release.Name }}.${SECRET_INTERNAL_DOMAIN}"
        parentRefs:
          - name: envoy-internal
            namespace: network
        rules:
          - backendRefs:
              - name: qbittorrent-app
                port: 80
      gluetun-webui:
        hostnames:
          - "{{ .Release.Name }}-gluetun.${SECRET_DOMAIN}"
          - "{{ .Release.Name }}-gluetun.${SECRET_INTERNAL_DOMAIN}"
        parentRefs:
          - name: envoy-internal
            namespace: network
        rules:
          - backendRefs:
              - name: qbittorrent-gluetun-webui
                port: 3000
    persistence:
      config:
        existingClaim: "{{ .Release.Name }}"
        advancedMounts:
          qbittorrent:
            app:
              - path: /config
      media:
        type: nfs
        server: ${SECRET_STORAGE_SERVER:-localhost}
        path: /mnt/pool/media
        globalMounts:
          - path: /media
            # dnsdist:
            #   type: configMap
            #   name: qbittorrent-dnsdist
            #   advancedMounts:
            #     qbittorrent:
            #       dnsdist:
            #         - path: /etc/dnsdist/dnsdist.conf
            #           subPath: dnsdist.conf
            #           readOnly: true

            # # TODO: Remove once snatches are sufficient
            # tempmedia:
            #   type: nfs
            #   server: ${TRUENAS_IP}
            #   path: /mnt/speed/snatch
            #   globalMounts:
            #     - path: /speed/snatch
