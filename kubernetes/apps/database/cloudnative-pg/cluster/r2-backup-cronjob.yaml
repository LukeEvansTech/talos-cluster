---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/batch/cronjob_v1.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres18-r2-backup
spec:
  schedule: "0 3 * * *" # Daily at 3:00 AM (after barman backup completes)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400 # Clean up jobs after 24 hours
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres18-r2-backup
            app.kubernetes.io/component: backup
        spec:
          automountServiceAccountToken: false
          restartPolicy: OnFailure
          containers:
            - name: rclone
              image: docker.io/rclone/rclone:1.71.2@sha256:e5ed44fd6896e31b0c2d1fc87ad4e45d0cf0d8b54e07abc1f9f5e2fa662e50cc
              imagePullPolicy: IfNotPresent
              args:
                - copy
                - --verbose
                - --stats-one-line
                - --stats=5m
                - --fast-list
                - minio:cnpg/
                - cloudflare:postgres18-backups/
              env:
                # Logging
                - name: RCLONE_VERBOSE
                  value: "1"

                # MinIO (source) configuration
                - name: RCLONE_CONFIG_MINIO_TYPE
                  value: s3
                - name: RCLONE_CONFIG_MINIO_PROVIDER
                  value: Minio
                - name: RCLONE_CONFIG_MINIO_ENDPOINT
                  value: https://minio.${SECRET_INTERNAL_DOMAIN}:9000
                - name: RCLONE_CONFIG_MINIO_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-r2-backup-secret
                      key: MINIO_ACCESS_KEY_ID
                - name: RCLONE_CONFIG_MINIO_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-r2-backup-secret
                      key: MINIO_SECRET_ACCESS_KEY
                - name: RCLONE_CONFIG_MINIO_ACL
                  value: private

                # Cloudflare R2 (destination) configuration
                - name: RCLONE_CONFIG_CLOUDFLARE_TYPE
                  value: s3
                - name: RCLONE_CONFIG_CLOUDFLARE_PROVIDER
                  value: Cloudflare
                - name: RCLONE_CONFIG_CLOUDFLARE_REGION
                  value: auto
                - name: RCLONE_CONFIG_CLOUDFLARE_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-r2-backup-secret
                      key: R2_ACCESS_KEY_ID
                - name: RCLONE_CONFIG_CLOUDFLARE_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-r2-backup-secret
                      key: R2_SECRET_ACCESS_KEY
                - name: RCLONE_CONFIG_CLOUDFLARE_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: cnpg-r2-backup-secret
                      key: R2_ENDPOINT
                - name: RCLONE_CONFIG_CLOUDFLARE_ACL
                  value: private
                - name: RCLONE_CONFIG_CLOUDFLARE_NO_CHECK_BUCKET
                  value: "true"

              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  memory: 512Mi

              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                runAsGroup: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
