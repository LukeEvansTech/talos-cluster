---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/batch/cronjob_v1.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres18-r2-backup
  namespace: database
spec:
  schedule: "0 3 * * *" # Daily at 3:00 AM (after barman backup completes)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400 # Clean up jobs after 24 hours
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres18-r2-backup
            app.kubernetes.io/component: backup
        spec:
          automountServiceAccountToken: false
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            fsGroup: 65534
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: rclone
              image: docker.io/rclone/rclone:1.72.0@sha256:0eb18825ac9732c21c11d654007170572bbd495352bb6dbb624f18e4f462c496
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  export RCLONE_CONFIG_MINIO_ACCESS_KEY_ID=$(cat /secrets/AWS_ACCESS_KEY_ID)
                  export RCLONE_CONFIG_MINIO_SECRET_ACCESS_KEY=$(cat /secrets/AWS_SECRET_ACCESS_KEY)
                  export RCLONE_CONFIG_CLOUDFLARE_ACCESS_KEY_ID=$(cat /secrets/R2_ACCESS_KEY_ID)
                  export RCLONE_CONFIG_CLOUDFLARE_SECRET_ACCESS_KEY=$(cat /secrets/R2_SECRET_ACCESS_KEY)
                  export RCLONE_CONFIG_CLOUDFLARE_ENDPOINT=$(cat /secrets/R2_ENDPOINT)
                  exec rclone copy --verbose --stats-one-line --stats=5m --fast-list minio:cnpg/ cloudflare:cnpg/
              env:
                # Logging
                - name: RCLONE_VERBOSE
                  value: "1"

                # MinIO (source) configuration
                - name: RCLONE_CONFIG_MINIO_TYPE
                  value: s3
                - name: RCLONE_CONFIG_MINIO_PROVIDER
                  value: Minio
                - name: RCLONE_CONFIG_MINIO_ENDPOINT
                  value: https://minio.${SECRET_INTERNAL_DOMAIN}:9000
                - name: RCLONE_CONFIG_MINIO_ACL
                  value: private

                # Cloudflare R2 (destination) configuration
                - name: RCLONE_CONFIG_CLOUDFLARE_TYPE
                  value: s3
                - name: RCLONE_CONFIG_CLOUDFLARE_PROVIDER
                  value: Cloudflare
                - name: RCLONE_CONFIG_CLOUDFLARE_REGION
                  value: auto
                - name: RCLONE_CONFIG_CLOUDFLARE_ACL
                  value: private
                - name: RCLONE_CONFIG_CLOUDFLARE_NO_CHECK_BUCKET
                  value: "true"

              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 512Mi

              volumeMounts:
                - name: secrets
                  mountPath: /secrets
                  readOnly: true

              securityContext:
                runAsNonRoot: true
                runAsUser: 65534
                runAsGroup: 65534
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: secrets
              secret:
                secretName: cloudnative-pg-secret
                defaultMode: 0400
