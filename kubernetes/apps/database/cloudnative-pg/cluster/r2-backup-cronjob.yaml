---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/batch/cronjob_v1.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres18-r2-backup
  namespace: database
  annotations:
    checkov.io/skip1: CKV_K8S_35=rclone requires environment variables for remote configuration
spec:
  schedule: "0 3 * * *" # Daily at 3:00 AM (after barman backup completes)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400 # Clean up jobs after 24 hours
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres18-r2-backup
            app.kubernetes.io/component: backup
        spec:
          automountServiceAccountToken: false
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            fsGroup: 65534
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: rclone
              image: docker.io/rclone/rclone:1.71.2@sha256:3103526c506266a9ecdf064efe99bf3677d92ef6407af124d8c56b4f49cbaa51
              imagePullPolicy: IfNotPresent
              args:
                - copy
                - --verbose
                - --stats-one-line
                - --stats=5m
                - --fast-list
                - minio:cnpg/
                - cloudflare:cnpg/
              env:
                # Logging
                - name: RCLONE_VERBOSE
                  value: "1"

                # MinIO (source) configuration
                - name: RCLONE_CONFIG_MINIO_TYPE
                  value: s3
                - name: RCLONE_CONFIG_MINIO_PROVIDER
                  value: Minio
                - name: RCLONE_CONFIG_MINIO_ENDPOINT
                  value: https://minio.${SECRET_INTERNAL_DOMAIN}:9000
                - name: RCLONE_CONFIG_MINIO_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: cloudnative-pg-secret
                      key: AWS_ACCESS_KEY_ID
                - name: RCLONE_CONFIG_MINIO_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cloudnative-pg-secret
                      key: AWS_SECRET_ACCESS_KEY
                - name: RCLONE_CONFIG_MINIO_ACL
                  value: private

                # Cloudflare R2 (destination) configuration
                - name: RCLONE_CONFIG_CLOUDFLARE_TYPE
                  value: s3
                - name: RCLONE_CONFIG_CLOUDFLARE_PROVIDER
                  value: Cloudflare
                - name: RCLONE_CONFIG_CLOUDFLARE_REGION
                  value: auto
                - name: RCLONE_CONFIG_CLOUDFLARE_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: cloudnative-pg-secret
                      key: R2_ACCESS_KEY_ID
                - name: RCLONE_CONFIG_CLOUDFLARE_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: cloudnative-pg-secret
                      key: R2_SECRET_ACCESS_KEY
                - name: RCLONE_CONFIG_CLOUDFLARE_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: cloudnative-pg-secret
                      key: R2_ENDPOINT
                - name: RCLONE_CONFIG_CLOUDFLARE_ACL
                  value: private
                - name: RCLONE_CONFIG_CLOUDFLARE_NO_CHECK_BUCKET
                  value: "true"

              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 512Mi

              securityContext:
                runAsNonRoot: true
                runAsUser: 65534
                runAsGroup: 65534
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
                seccompProfile:
                  type: RuntimeDefault
