---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: postgres18-backup
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: postgres18-backup
    namespace: database
  values:
    controllers:
      postgres-backup:
        type: cronjob
        cronjob:
          schedule: "0 * * * *" # Every hour
          concurrencyPolicy: Forbid
          successfulJobsHistory: 1
          failedJobsHistory: 1

        containers:
          app:
            image:
              repository: ghcr.io/tiredofit/docker-db-backup
              tag: 4.1.21
            env:
              - name: DB_TYPE
                value: pgsql
              - name: DB_HOST
                value: postgres18-rw.database.svc.cluster.local
              - name: DB_PORT
                value: "5432"
              - name: DB_USER
                valueFrom:
                  secretKeyRef:
                    name: cloudnative-pg-secret
                    key: username
              - name: DB_PASS
                valueFrom:
                  secretKeyRef:
                    name: cloudnative-pg-secret
                    key: password
              - name: DB_NAME
                value: ALL
              - name: DB_EXCLUDE
                value: template0,template1
              - name: DB_BACKUP_LOCATION
                value: FILESYSTEM
              - name: DB_DUMP_TARGET
                value: /backups/database/postgresql
              - name: DB_CLEANUP_TIME
                value: "259200" # 180 days in minutes (180 × 24 × 60)
              - name: DB_COMPRESSION
                value: GZ
              - name: DB_COMPRESSION_LEVEL
                value: "9"
              - name: CHECKSUM
                value: SHA1
              - name: TIMEZONE
                value: ${TIMEZONE}
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL

    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch

    persistence:
      backups:
        type: nfs
        server: ${SECRET_STORAGE_SERVER}
        path: /mnt/pool/backups
        globalMounts:
          - path: /backups
            subPath: postgres
